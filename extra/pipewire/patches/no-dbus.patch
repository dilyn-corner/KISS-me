From e4e3763abf52c0ee1f91168f0d0ac7985a4ef487 Mon Sep 17 00:00:00 2001
From: git-bruh <e817509a-8ee9-4332-b0ad-3a6bdf9ab63f@aleeas.com>
Date: Sat, 18 Sep 2021 15:34:36 +0530
Subject: [PATCH] make dbus support optional

---
 meson.build                                   |  6 +++-
 meson_options.txt                             |  4 +++
 spa/plugins/support/meson.build               | 17 +++++-----
 src/examples/media-session/alsa-monitor.c     | 33 ++++++++++++++++++-
 src/examples/media-session/media-session.c    |  6 ++++
 src/examples/meson.build                      |  6 +++-
 src/modules/meson.build                       |  5 ++-
 src/modules/module-protocol-pulse/internal.h  |  2 ++
 .../module-protocol-pulse/pulse-server.c      |  4 +++
 test/meson.build                              | 24 +++++++++-----
 10 files changed, 86 insertions(+), 21 deletions(-)

diff --git a/meson.build b/meson.build
index c9b98c8..a8b2661 100644
--- a/meson.build
+++ b/meson.build
@@ -320,7 +320,11 @@ mathlib = cc.find_library('m', required : false)
 rt_lib = cc.find_library('rt', required : false) # clock_gettime
 dl_lib = cc.find_library('dl', required : false)
 pthread_lib = dependency('threads')
-dbus_dep = dependency('dbus-1')
+dbus_dep = dependency('dbus-1', required : get_option('dbus'))
+summary({'dbus': dbus_dep.found()}, bool_yn: true)
+if dbus_dep.found() and dbus_dep.found()
+  cdata.set('HAVE_DBUS', 1)
+endif
 sdl_dep = dependency('sdl2', required : get_option('sdl2'))
 summary({'SDL 2': sdl_dep.found()}, bool_yn: true, section: 'Misc dependencies')
 ncurses_dep = dependency('ncursesw', required : false)
diff --git a/meson_options.txt b/meson_options.txt
index 3d4d653..a1894cf 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -30,6 +30,10 @@ option('gstreamer-device-provider',
        description: 'Build GStreamer device provider plugin',
        type: 'feature',
        value: 'auto')
+option('dbus',
+       description: 'Enable dbus support',
+       type: 'feature',
+       value: 'auto')
 option('systemd',
        description: 'Enable systemd integration',
        type: 'feature',
diff --git a/spa/plugins/support/meson.build b/spa/plugins/support/meson.build
index d95c098..dc1a06f 100644
--- a/spa/plugins/support/meson.build
+++ b/spa/plugins/support/meson.build
@@ -30,15 +30,16 @@ if not get_option('evl').disabled()
 		        install_dir : spa_plugindir / 'support')
 endif
 
-spa_dbus_sources = ['dbus.c']
-
-spa_dbus_lib = shared_library('spa-dbus',
-			spa_dbus_sources,
-			include_directories : [ spa_inc],
-			dependencies : [dbus_dep, ],
-			install : true,
-		        install_dir : spa_plugindir / 'support')
+if dbus_dep.found()
+  spa_dbus_sources = ['dbus.c']
 
+  spa_dbus_lib = shared_library('spa-dbus',
+			  spa_dbus_sources,
+			  include_directories : [ spa_inc],
+			  dependencies : [dbus_dep, ],
+			  install : true,
+		          install_dir : spa_plugindir / 'support')
+endif
 
 if systemd_dep.found()
   spa_journal_sources = ['journal.c']
diff --git a/src/examples/media-session/alsa-monitor.c b/src/examples/media-session/alsa-monitor.c
index 4cb6e84..32581fb 100644
--- a/src/examples/media-session/alsa-monitor.c
+++ b/src/examples/media-session/alsa-monitor.c
@@ -48,7 +48,9 @@
 #include <spa/pod/parser.h>
 #include <spa/debug/dict.h>
 #include <spa/debug/pod.h>
+#ifdef HAVE_DBUS
 #include <spa/support/dbus.h>
+#endif
 
 #include <pipewire/pipewire.h>
 #include <pipewire/i18n.h>
@@ -56,7 +58,9 @@
 
 #include "media-session.h"
 
+#ifdef HAVE_DBUS
 #include "reserve.c"
+#endif
 
 /** \page page_media_session_module_alsa_monitor Media Session Module: ALSA Monitor
  *
@@ -148,7 +152,9 @@ struct device {
 
 	char *factory_name;
 
+#ifdef HAVE_DBUS
 	struct rd_device *reserve;
+#endif
 	struct spa_hook sync_listener;
 	int seq;
 	int priority;
@@ -256,8 +262,15 @@ static int node_release(void *data)
 
 	node->acquired = false;
 
-	if (device && --device->n_acquired == 0 && device->reserve)
+	if (device && --device->n_acquired == 0
+#ifdef HAVE_DBUS
+	&& device->reserve
+#endif
+	) {
+#ifdef HAVE_DBUS
 		rd_device_release(device->reserve);
+#endif
+	}
 	return 0;
 }
 
@@ -703,6 +716,7 @@ static void set_profile(struct device *device, int index)
 	}
 }
 
+#ifdef HAVE_DBUS
 static void set_jack_profile(struct impl *impl, int index)
 {
 	char buf[1024];
@@ -747,16 +761,20 @@ static void add_jack_timeout(struct impl *impl)
 	value.tv_nsec = 0;
 	pw_loop_update_timer(main_loop, impl->jack_timeout, &value, NULL, false);
 }
+#endif
 
 static void do_reserve_acquired(struct device *device)
 {
 	if (!device->probed)
 		probe_device(device);
 
+#ifdef HAVE_DBUS
 	if (device->n_acquired == 0 && device->reserve)
 		rd_device_release(device->reserve);
+#endif
 }
 
+#ifdef HAVE_DBUS
 static void reserve_acquired(void *data, struct rd_device *d)
 {
 	struct device *device = data;
@@ -857,16 +875,20 @@ static const struct rd_device_callbacks reserve_callbacks = {
 	.busy = reserve_busy,
 	.available = reserve_available,
 };
+#endif
 
 static int do_device_acquire(struct device *device)
 {
 	struct impl *impl = device->impl;
+#ifdef HAVE_DBUS
 	struct sm_media_session *session = impl->session;
 	int res;
+#endif
 
 	if (!impl->reserve)
 		goto done;
 
+#ifdef HAVE_DBUS
 	if (device->reserve == NULL) {
 		const char *reserve;
 		const char *path = pw_properties_get(device->props, SPA_KEY_API_ALSA_PATH);
@@ -903,13 +925,16 @@ static int do_device_acquire(struct device *device)
 		goto done;
 	}
 	return res;
+#endif
 
 done:
 	do_reserve_acquired(device);
+#ifdef HAVE_DBUS
 	if (device->reserve != NULL) {
 		rd_device_destroy(device->reserve);
 		device->reserve = NULL;
 	}
+#endif
 	return 0;
 }
 
@@ -928,8 +953,10 @@ static void device_destroy(void *data)
 		spa_hook_remove(&device->device_listener);
 	if (device->seq != 0)
 		spa_hook_remove(&device->sync_listener);
+#ifdef HAVE_DBUS
 	if (device->reserve)
 		rd_device_destroy(device->reserve);
+#endif
 }
 
 static void device_free(void *data)
@@ -1136,7 +1163,9 @@ static int alsa_start_jack_device(struct impl *impl)
 static void session_destroy(void *data)
 {
 	struct impl *impl = data;
+#ifdef HAVE_DBUS
 	remove_jack_timeout(impl);
+#endif
 	spa_hook_remove(&impl->session_listener);
 	spa_hook_remove(&impl->listener);
 	if (impl->jack_device)
@@ -1153,9 +1182,11 @@ static void session_dbus_disconnected(void *data)
 	struct impl *impl = data;
 
 	spa_list_for_each(d, &impl->device_list, link) {
+#ifdef HAVE_DBUS
 		if (d->reserve != NULL)
 			rd_device_destroy(d->reserve);
 		d->reserve = NULL;
+#endif
 	}
 }
 
diff --git a/src/examples/media-session/media-session.c b/src/examples/media-session/media-session.c
index 7b94e5b..4854454 100644
--- a/src/examples/media-session/media-session.c
+++ b/src/examples/media-session/media-session.c
@@ -58,7 +58,9 @@
 #include "pipewire/extensions/session-manager.h"
 #include "pipewire/extensions/client-node.h"
 
+#ifdef HAVE_DBUS
 #include <dbus/dbus.h>
+#endif
 
 #include "media-session.h"
 
@@ -84,7 +86,9 @@
 #define sm_media_session_emit_dbus_disconnected(s)	sm_media_session_emit(s, dbus_disconnected, 0)
 
 int sm_access_flatpak_start(struct sm_media_session *sess);
+#ifdef HAVE_DBUS
 int sm_access_portal_start(struct sm_media_session *sess);
+#endif
 int sm_default_nodes_start(struct sm_media_session *sess);
 int sm_default_profile_start(struct sm_media_session *sess);
 int sm_default_routes_start(struct sm_media_session *sess);
@@ -2384,7 +2388,9 @@ static const struct {
 
 } modules[] = {
 	{ "flatpak", "manage flatpak access", sm_access_flatpak_start, NULL },
+#ifdef HAVE_DBUS
 	{ "portal", "manage portal permissions", sm_access_portal_start, NULL },
+#endif
 	{ "metadata", "export metadata API", sm_metadata_start, NULL },
 	{ "default-nodes", "restore default nodes", sm_default_nodes_start, NULL },
 	{ "default-profile", "restore default profiles", sm_default_profile_start, NULL },
diff --git a/src/examples/meson.build b/src/examples/meson.build
index 680e36a..1b4ad46 100644
--- a/src/examples/meson.build
+++ b/src/examples/meson.build
@@ -69,7 +69,6 @@ if get_option('session-managers').contains('media-session')
   endif
   media_session_sources += [
     'media-session/access-flatpak.c',
-    'media-session/access-portal.c',
     'media-session/alsa-no-dsp.c',
     'media-session/alsa-midi.c',
     'media-session/alsa-monitor.c',
@@ -94,6 +93,9 @@ if get_option('session-managers').contains('media-session')
     'media-session/libcamera-monitor.c',
     'media-session/suspend-node.c',
   ] + sm_logind_src
+  if dbus_dep.found()
+    media_session_sources += ['media-session/access-portal.c']
+  endif
   executable('pipewire-media-session',
     media_session_sources,
     install: true,
@@ -101,11 +103,13 @@ if get_option('session-managers').contains('media-session')
 )
 endif
 
+if dbus_dep.found()
 executable('pw-reserve',
 	'media-session/pw-reserve.c',
 	install: true,
 	dependencies : [dbus_dep, pipewire_dep],
 )
+endif
 
 executable('bluez-session',
   'bluez-session.c',
diff --git a/src/modules/meson.build b/src/modules/meson.build
index b2bb2da..9ee30e3 100644
--- a/src/modules/meson.build
+++ b/src/modules/meson.build
@@ -209,7 +209,6 @@ pipewire_module_protocol_pulse_sources = [
   'module-protocol-pulse.c',
   'module-protocol-pulse/client.c',
   'module-protocol-pulse/collect.c',
-  'module-protocol-pulse/dbus-name.c',
   'module-protocol-pulse/extension.c',
   'module-protocol-pulse/format.c',
   'module-protocol-pulse/manager.c',
@@ -246,6 +245,10 @@ pipewire_module_protocol_pulse_sources = [
   'module-protocol-pulse/modules/module-zeroconf-discover.c',
 ]
 
+if dbus_dep.found()
+  pipewire_module_protocol_pulse_sources += 'module-protocol-pulse/dbus-name.c'
+endif
+
 if avahi_dep.found()
   pipewire_module_protocol_pulse_sources += [
     'module-protocol-pulse/modules/module-zeroconf-publish.c',
diff --git a/src/modules/module-protocol-pulse/internal.h b/src/modules/module-protocol-pulse/internal.h
index 9ece0ba..92fbb4a 100644
--- a/src/modules/module-protocol-pulse/internal.h
+++ b/src/modules/module-protocol-pulse/internal.h
@@ -67,7 +67,9 @@ struct impl {
 	struct spa_hook context_listener;
 
 	struct pw_properties *props;
+#ifdef HAVE_DBUS
 	void *dbus_name;
+#endif
 
 	struct ratelimit rate_limit;
 
diff --git a/src/modules/module-protocol-pulse/pulse-server.c b/src/modules/module-protocol-pulse/pulse-server.c
index eda21b5..4327bb3 100644
--- a/src/modules/module-protocol-pulse/pulse-server.c
+++ b/src/modules/module-protocol-pulse/pulse-server.c
@@ -4935,8 +4935,10 @@ static void impl_free(struct impl *impl)
 	struct client *c;
 	struct message *msg;
 
+#ifdef HAVE_DBUS
 	if (impl->dbus_name)
 		dbus_release_name(impl->dbus_name);
+#endif
 
 	spa_list_consume(msg, &impl->free_messages, link)
 		message_free(impl, msg, true, true);
@@ -5110,7 +5112,9 @@ struct pw_protocol_pulse *pw_protocol_pulse_new(struct pw_context *context,
 	pw_context_add_listener(context, &impl->context_listener,
 			&context_events, impl);
 
+#ifdef HAVE_DBUS
 	impl->dbus_name = dbus_request_name(context, "org.pulseaudio.Server");
+#endif
 
 	return (struct pw_protocol_pulse *) impl;
 
diff --git a/test/meson.build b/test/meson.build
index bbef49d..a28062a 100644
--- a/test/meson.build
+++ b/test/meson.build
@@ -67,20 +67,26 @@ test('test client',
                include_directories: pwtest_inc,
                link_with: pwtest_lib)
 )
+context_link_with = [
+	pwtest_lib,
+	spa_support_lib,
+	pipewire_module_protocol_native,
+	pipewire_module_client_node,
+	pipewire_module_client_device,
+	pipewire_module_adapter,
+	pipewire_module_metadata,
+	pipewire_module_session_manager
+]
+
+if dbus_dep.found()
+  context_link_with += spa_dbus_lib
+endif
 test('test context',
     executable('test-context',
                'test-context.c',
                'test-config.c',
                include_directories: pwtest_inc,
-               link_with: [pwtest_lib,
-                            spa_support_lib,
-                            spa_dbus_lib,
-                            pipewire_module_protocol_native,
-                            pipewire_module_client_node,
-                            pipewire_module_client_device,
-                            pipewire_module_adapter,
-                            pipewire_module_metadata,
-                            pipewire_module_session_manager])
+               link_with: context_link_with)
 )
 test('test support',
     executable('test-support',
-- 
2.33.0

