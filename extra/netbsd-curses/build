#!/bin/sh -e
# Intentional, globbing disabled, respect macros
# shellcheck disable=2086,2089,2090

# We could at one point simply turn this into a Makefile.
# These are the lengths we will go to to avoid gmake.
# Just builds static libs and programs!

# We'd like to see what we're doing
log() {
    printf '%s\n' "---  $3  ---"
    printf '%s %s %s\n' "$@"
}

export TOOL_AWK=awk
export TOOL_SED=sed
export TOOL_TIC=tic/host_tic
export TOOL_SORT=sort
export TOOL_NBPERF=nbperf/nbperf
export TERMINFODIR=./terminfo
export CFLAGS="$CFLAGS -fPIC -Wno-macro-redefined"
export IFLAGS="-I. -I./libterminfo -I./tic -I./libcurses \
               -I./libmenu -I./libform -I./libpanel"
export NFLAGS="-DHAVE_WCHAR -DTERMINFO_COMPILE -DTERMINFO_DB \
               -DTERMINFO_COMPAT -DINSTALL_PREFIX=\"/usr\""

for file in tic/*.c nbperf/*.c; do
    log CC "${file%%.c}.o" "$file"
    ${CC:-cc} $IFLAGS $NFLAGS $CFLAGS \
        -c -o "${file%%.c}.o" "$file"
done

log CC nbperf nbperf.o
${CC:-cc} $IFLAGS nbperf/*.o -o nbperf/nbperf

log genhash nbperf libterminfo/hash.c
./libterminfo/genhash \
    libterminfo/term.h \
    nbperf/nbperf > libterminfo/hash.c

log CC hash.o hash.c
cp libterminfo/hash.c tic/hash.c
${CC:-cc} $IFLAGS $NFLAGS $CFLAGS \
    -c -o tic/hash.o tic/hash.c

log CCLD tic tic.o
${CC:-cc} $IFLAGS -static tic/*.o -o tic/tic

ln -sf tic tic/host_tic

log genterms tic libterminfo/compiled_terms.c
./libterminfo/genterms \
    libterminfo/term.h \
    terminfo/terminfo \
    tic/host_tic > libterminfo/compiled_terms.c

for file in term.c ti.c setupterm.c curterm.c tparm.c tputs.c \
            compile.c hash.c cdbr.c mi_vector_hash.c; do
    log CC "${file%%.c}.o" "$file"
    ${CC:-cc} $IFLAGS $NFLAGS $CFLAGS \
        -c -o "libterminfo/${file%%.c}.o" "libterminfo/$file"
done

log genthash nbperf libterminfo/termcap_hash.c
./libterminfo/genthash \
    libterminfo/termcap_map.c \
    nbperf/nbperf > libterminfo/termcap_hash.c

rm -f libcurses/tscroll.c
for file in libterminfo/termcap.c libcurses/*.c libpanel/*.c \
            libmenu/*.c libform/*.c tset/*.c tput/tput.c     \
            infocmp/infocmp.c tabs/tabs.c; do
    log CC "${file%%.c}.o" "$file"
    ${CC:-cc} $IFLAGS $CFLAGS \
        -c -o "${file%%.c}.o" "$file"
done

for lib in libterminfo libcurses libpanel libmenu libform; do
    log AR "$lib" "${lib}.o"
    ${AR:-ar} crs "$lib/${lib}.a" $lib/*.o
done

for file in tset tput tabs infocmp; do
    log CCLD "$file" libterminfo.a
    ${CC:-cc} -o "$file/$file" $file/*.o libterminfo/libterminfo.a -static
done

log CCLD libterminfo.sh xxx.o
cc -shared -o libterminfo/libterminfo.so \
    libterminfo/*.o -Wl,-soname=libterminfo.so
log CCLD libcurses.so xxx.o
cc -shared -o libcurses/libcurses.so \
    libcurses/*.o libterminfo/libterminfo.so -Wl,-soname=libcurses.so
log CCLD libpanel.so xxx.o
cc -shared -o libpanel/libpanel.so \
    libpanel/*.o libcurses/libcurses.so -Wl,-soname=libpanel.so
log CCLD libmenu.so xxx.o
cc -shared -o libmenu/libmenu.so \
    libmenu/*.o libcurses/libcurses.so -Wl,-soname=libmenu.so
log CCLD libform.so xxx.o
cc -shared -o libform/libform.so \
    libform/*.o libcurses/libcurses.so -Wl,-soname=libform.so

# Install binaries, libraries, headers, and pkgconfig files
install -Dm755 tput/clear.sh "$1/usr/bin/clear"

for bin in tabs tput tset infocmp; do
    install -Dm755 "$bin/$bin" "$1/usr/bin/$bin"
done

for lib in libform libmenu libpanel libcurses libterminfo; do
    install -Dm644 "$lib/${lib}.a"  "$1/usr/lib/${lib}.a"
    install -Dm644 "$lib/${lib}.so" "$1/usr/lib/${lib}.so"
done

for pc in menu form formw menuw panel curses panelw \
          ncurses termcap ncursesw terminfo; do
    install -Dm644 "${pc}.pc" "$1/usr/lib/pkgconfig/${pc}.pc"
done

for hdr in libmenu/eti.h libform/form.h libterminfo/term.h    \
           libmenu/menu.h libpanel/panel.h libcurses/curses.h \
           libcurses/unctrl.h libterminfo/termcap.h; do
    install -Dm644 "$hdr" "$1/usr/include/${hdr#*/}"
done

# Create symlinks that are expected to exist
ln -sf tset           "$1/usr/bin/reset"
ln -sf curses.h       "$1/usr/include/ncurses.h"

ln -sf libmenu.a      "$1/usr/lib/libmenuw.a"
ln -sf libform.a      "$1/usr/lib/libformw.a"
ln -sf libpanel.a     "$1/usr/lib/libpanelw.a"
ln -sf libcurses.a    "$1/usr/lib/libncurses.a"
ln -sf libterminfo.a  "$1/usr/lib/libtermcap.a"
ln -sf libcurses.a    "$1/usr/lib/libncursesw.a"

ln -sf libmenu.so     "$1/usr/lib/libmenuw.so"
ln -sf libform.so     "$1/usr/lib/libformw.so"
ln -sf libpanel.so    "$1/usr/lib/libpanelw.so"
ln -sf libterminfo.so "$1/usr/lib/libtermcap.so"
ln -sf libcurses.so   "$1/usr/lib/libncurses.so"
ln -sf libcurses.so   "$1/usr/lib/libncursesw.so"

# Install the license
install -Dm755 COPYING "$1/usr/share/LICENSES/netbsd-curses.license"
