#!/bin/sh -e

export CFLAGS="$CFLAGS -fPIC"

sed -i '/assembler-with-cpp/s%\$<%$(top_srcdir)/libffi.map.in%' Makefile.in

./configure \
    --prefix=/usr

# tail -[0-9] works for say, toybox tail
# but not for uutils tail
sed -i 's/tail -1/tail -n1/g' Makefile

make
make DESTDIR="$1" install

rm -rf "$1/usr/share/info"

# Create a symlink to avoid rebuilds
ln -s libffi.so.8 "$1/usr/lib/libffi.so.7"

# Install the license
install -Dm755 LICENSE "$1/usr/share/LICENSES/libffi.license"
