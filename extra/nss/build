#!/bin/sh -e

CFLAGS=$(printf   %s "$CFLAGS"   | sed 's/-flto=thin//')
CXXFLAGS=$(printf %s "$CXXFLAGS" | sed 's/-flto=thin//')

export NSS_USE_SYSTEM_SQLITE=1
export NSS_ENABLE_WERROR=0
export USE_64=1
export BUILD_OPT=1
export NSS_DISABLE_GTESTS=1
export CC="${CC:-cc}"
export CCC="${CXX:-c++}"
export CXX="${CXX:-c++}"

# People just don't believe in clang enough, I guess.
sed -i '/-no-integrated-as/d' nss/lib/freebl/Makefile

gmake -j1 -C nss nss_build_all

install -Dt "$1/usr/include/nss" -m644 dist/public/nss/*.h
install -Dt "$1/usr/include/nss" -m644 dist/Linux*/include/*.h
install -Dt "$1/usr/lib"               dist/Linux*/lib/*.so
install -Dt "$1/usr/lib"         -m644 dist/Linux*/lib/*.chk

# Install the NSPR files. This is a joint package as I'd
# rather not juggle which version of NSPR works best with NSS.
install -Dt "$1/usr/include/nspr" -m644 nspr/pr/include/*.h
install -Dt "$1/usr/include/nspr" -m644 nspr/lib/*/*.h

# Disgusting. Disgusting. Disgusting. Disgusting. Disgusting.
find nspr/Linux* -name \*.so \
    -exec install -Dt "$1/usr/lib" {} \;

# Install the pkgconfig files
install -Dm644 nss.pc  "$1/usr/lib/pkgconfig/nss.pc"
install -Dm644 nspr.pc "$1/usr/lib/pkgconfig/nspr.pc"

# Install the license
install -Dm755 nss/COPYING "$1/usr/share/LICENSES/nss.license"
